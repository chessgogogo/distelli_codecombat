bmcgehee/distelli_codecombat:
  Env:
    - PORT: 3000
    - COCO: ~/src/coco
    - COCO_TREE: ~/src/coco/codecombat
    - COCO_DB: ~/src/coco/db
    - MONGO_DL: ~/mongodl

  PreInstall:
    - mkdir -p $COCO_TREE
    - cd $COCO
    - sudo apt-get -y update
    - sudo apt-get -y install make build-essential ruby ruby-dev curl git
    - git clone https://github.com/codecombat/codecombat.git
    - sudo add-apt-repository -y ppa:chris-lea/node.js
    - sudo apt-get -y update
    - sudo apt-get -y install nodejs
    - cd $COCO_TREE
    - npm install
    - sudo npm install -g brunch
    - sudo npm install -g bower
    - sudo gem install sass
    - bower install
    - mkdir -p $MONGO_DL
    - cd $MONGO_DL
    - wget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-ubuntu1404-3.0.3.tgz
    - tar xvfz mongodb-linux-x86_64-ubuntu1404-3.0.3.tgz
    - sudo cp mongodb-linux-x86_64-ubuntu1404-3.0.3/bin/* /usr/local/bin
    - sudo mkdir -p /data/db
    - sudo chown -R distelli:distelli /data/db
    - mkdir -p $COCO_DB
    - cd $COCO_DB
    - wget http://analytics.codecombat.com:8080/dump.tar.gz
    - tar xvfz dump.tar.gz
    - cd $COCO_TREE
    - bin/coco-mongodb &
    - sleep 4
    - cd $COCO_DB
    - mongorestore --drop dump
    - sleep 4
    - sudo bin/coco-brunch &

  Exec:
    - cd $COCO_TREE
    - bin/coco-dev-server

